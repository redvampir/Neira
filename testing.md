# Тестирование Neira

Этот документ описывает базовые уровни тестирования и минимальные бенчмарки для модуля Neira.

## Уровни тестирования

### Unit-тесты
- Проверяют отдельные функции и узлы без внешних зависимостей.
- Для каждого узла пишите тесты на корректный результат, обработку ошибок и граничные случаи.
- Минимум два теста на каждую публичную функцию.

### Интеграционные тесты
- Проверяют взаимодействие узлов в типичных сценариях.
- Используют реальные подключения между Action, Analysis и Memory узлами.
- Покрывают запуск базового сценария диалога и генерации кода.

## Минимальные бенчмарки
- Запуск одного Action/Analysis цикла не более 100 мс на CPU 4×2.0 ГГц.
- Потребление памяти при полном наборе тестов не более 512 МБ.
- Интеграционный тест с цепочкой из 10 узлов завершается менее чем за 2 с.

Результаты бенчмарков фиксируются в логах CI. Если значения превышены более чем на 20 %, задача возвращается на доработку.

## Sandbox‑изоляция

- **Виртуальная среда** — все процессы запускаются в отдельном окружении с изолированными сетевыми и файловыми правами.
- **Компиляция** — исходный код компилируется в безопасном контейнере, исключающем доступ к внешним ресурсам.
- **Тестовая среда** — исполняемые файлы выполняются только в инструментированных тестах с минимальными правами.

## Этапы развития возможностей

1. **Параметры** — конфигурация через ограниченные входные значения.
2. **Композиция** — комбинирование готовых блоков без изменения их внутренней логики.
3. **Паттерны** — использование шаблонов проектирования для формирования типовых решений.
4. **Полная генерация** — автоматическое создание кода и сценариев на основе высокого уровня описания.

## Статический анализ

- Проверка стиля, типов и зависимостей перед выполнением.
- Использование линтеров и инструментов анализа графа вызовов.

## Динамическое тестирование

- Прогон симуляций с реальными данными и мониторингом поведения.
- Обработка ошибок и метрик исполнения в режиме реального времени.

## Лимиты ресурсов

- Ограничения по времени CPU, объёму памяти и операциям ввода‑вывода.
- Прерывание задач, превышающих установленные квоты.

## Принципы безопасности

- **Never trust** — входные данные считаются потенциально вредоносными.
- **Fail fast** — обнаруженные нарушения приводят к немедленному завершению.
- **Gradual expansion** — разрешения расширяются только по мере необходимости.
- **Human oversight** — критические действия требуют участия человека.
- **Audit trail** — каждый этап фиксируется для последующего анализа.

## Тестирование схем и генератора

- Проверка загрузки разных версий схем `NodeTemplate`. Тесты поочередно читают файлы `schemas/v1/node-template.schema.json` и будущие версии, убеждаясь в успешной десериализации. При попытке загрузить шаблон с несовпадающей версией тест должен завершиться с ошибкой.
- Автоматическая проверка генератора: запуск генератора шаблона, валидация результата по схеме и десериализация в структуру `NodeTemplate`.

```bash
cargo test --test node_template_validation_test
cargo run --example generate_node
```

## Windows

### Установка Node.js 20

```powershell
winget install OpenJS.NodeJS.LTS --version 20
node -v
```

### Установка Rust 1.75

```powershell
winget install Rustlang.Rustup
rustup default 1.75
rustc --version
```

### Особенности `npm test` и `cargo test`

```powershell
npm test
cargo test
```

- Переменные среды задаются через `setx` или `$Env:VAR=значение`.
- Для скриптов, рассчитанных на Unix, может потребоваться пакет `cross-env`.
- `cargo test` создаёт `.exe` файлы; пути в тестах следует указывать с `\\`.

## macOS

### Установка Node.js 20

```bash
brew install node@20
node -v
```

### Установка Rust 1.75

```bash
brew install rustup
rustup-init -y
rustup install 1.75.0
rustup default 1.75.0
rustc --version
```

### Особенности `npm test` и `cargo test`

```bash
npm test
cargo test
```

- При необходимости используйте `sudo` для установки зависимостей.
- Инструменты сборки требуют Xcode Command Line Tools (`xcode-select --install`).
- `cargo test` может запрашивать доступ к сети для скачивания зависимостей.

## Добавленные сценарии

- Unit-тест для `hello` в `src/index.ts` теперь дополнительно проверяет длину возвращаемой строки.
- Unit-тест для `greet` в `src/lib.rs` дополнен проверкой длины возвращаемой строки.
