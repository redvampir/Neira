<!-- neira:meta
id: NEI-20240909-120000-lymphatic-filter
intent: docs
summary: Описан фильтр лимфатической системы и анализ дубликатов.
-->

# Фильтр лимфатической системы

Фильтр лимфатической системы отвечает за поиск и нейтрализацию дублирующегося
функционала. Он предотвращает рост "лишних" генов, облегчая сопровождение и
повышая устойчивость к ошибкам.

## Этапы анализа дубликатов

### Сигнатурный анализ
Из каждого модуля извлекается AST и строится хеш по структуре функции, её
параметрам и типам. Совпадение отпечатков ставит функции в группу риска.
Метод быстр и дёшев, но не учитывает тонкие синтаксические отличия.

### Поведенческий анализ
Функции запускаются на наборе тестовых входов. Сравниваются выходы и побочные
эффекты. Совпадение на достаточном количестве кейсов трактуется как
функциональный клон. Подходит для разных реализаций одного алгоритма, но
требует тщательного подбора тестов.

### Семантический анализ
Сравниваются имена, комментарии, публикации в EventBus и сообщения в журналах.
ИИ‑модель сопоставляет смысл и повышает индекс подозрения при близком
контексте. Метод помогает поймать скрытые связи, но подвержен ложным
срабатываниям.

### Структурный анализ
Каждая функция получает уникальный идентификатор (Gene ID). Перед добавлением
нового кода система ищет совпадения в базе существующих генов. Высокая
схожесть инициирует уведомление разработчику.

## Взаимодействие с иммунной системой
При обнаружении потенциального дубликата фильтр публикует событие
`lymphatic.duplicate_found` в `EventBus`. Иммунная система подписывается на
этот топик и решает, блокировать ли добавление гена либо пометить его как
безопасный. Все решения фиксируются в `logs/events.ndjson` для аудита.

## Риски тонких различий
Иногда функции выглядят одинаково, но различаются:

- побочными эффектами (I/O, состояние);
- диапазонами входных значений;
- требованиями к производительности или памяти;
- зависимостями от внешних API.

Слияние таких функций может вызвать ошибки на границах входа или регрессию по
времени выполнения.

### Когда дубликат можно оставить
- Различия в поведении критичны для отдельных органов или режимов.
- Производительность или потребление ресурсов существенно отличается.
- Нужна обратная совместимость с внешним API.
- Стоимость объединения выше потенциальной выгоды.

Каждое исключение фиксируется событием `lymphatic.duplicate_resolved` с
указанием причины, что позволяет иммунной системе и разработчикам отслеживать
оставленные дубликаты.
