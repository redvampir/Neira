<!-- neira:meta
id: NEI-20240909-120000-lymphatic-filter
intent: docs
summary: Описан фильтр лимфатической системы и анализ дубликатов.
-->
<!-- neira:meta
id: NEI-20270610-120400-lymphatic-activated-doc
intent: docs
summary: Добавлено событие lymphatic_filter.activated и его поля.
-->
<!-- neira:meta
id: NEI-20270615-lymphatic-impl-doc
intent: docs
summary: Описана реализация сканирования репозитория и событие duplicate_found.
-->

# Фильтр лимфатической системы

Фильтр лимфатической системы отвечает за поиск и нейтрализацию дублирующегося
функционала. Он предотвращает рост "лишних" генов, облегчая сопровождение и
повышая устойчивость к ошибкам.

## Реализация

Модуль `immune_system::lymphatic_filter` обходит рабочее пространство при помощи
`walkdir`, строит AST-фингерпринты функций через `syn` и сравнивает их на четырёх
уровнях: сигнатурном, поведенческом, семантическом и структурном. Для каждого
совпадения публикуется событие `lymphatic.duplicate_found` с полями `gene_id`,
`location`, `similarity` и `decision`. Событие логируется в `logs/events.ndjson`,
а метрики `lymphatic_duplicates_found_total` и
`lymphatic_artifacts_removed_total` отражают количество обнаруженных и удалённых
дубликатов.

## Этапы анализа дубликатов

### Сигнатурный анализ

Из каждого модуля извлекается AST и строится хеш по структуре функции, её
параметрам и типам. Совпадение отпечатков ставит функции в группу риска.
Метод быстр и дёшев, но не учитывает тонкие синтаксические отличия.

### Поведенческий анализ

Функции запускаются на наборе тестовых входов. Сравниваются выходы и побочные
эффекты. Совпадение на достаточном количестве кейсов трактуется как
функциональный клон. Подходит для разных реализаций одного алгоритма, но
требует тщательного подбора тестов.

### Семантический анализ

Сравниваются имена, комментарии, публикации в EventBus и сообщения в журналах.
ИИ‑модель сопоставляет смысл и повышает индекс подозрения при близком
контексте. Метод помогает поймать скрытые связи, но подвержен ложным
срабатываниям.

### Структурный анализ

Каждая функция получает уникальный идентификатор (Gene ID). Перед добавлением
нового кода система ищет совпадения в базе существующих генов. Высокая
схожесть инициирует уведомление разработчику.

## Взаимодействие с иммунной системой

При обнаружении потенциального дубликата фильтр публикует событие
`lymphatic.duplicate_found` в `EventBus`. Иммунная система подписывается на
этот топик и решает, блокировать ли добавление гена либо пометить его как
безопасный. Все решения фиксируются в `logs/events.ndjson` для аудита.

Перед запуском анализа публикуется событие `lymphatic_filter.activated` со
следующими полями:

| Поле        | Описание                              |
| ----------- | ------------------------------------- |
| function_id | идентификатор проверяемой функции     |
| similarity  | степень похожести в диапазоне 0–1     |
| decision    | `keep` — оставить, `remove` — удалить |

Пример записи в журнале:

```json
{
  "id": 1,
  "ts_ms": 0,
  "name": "lymphatic_filter.activated",
  "data": { "function_id": "FUNC1", "similarity": 0.95, "decision": "keep" }
}
```

Иммунная система реагирует на событие и может инициировать удаление или
пропустить дубликат.

Пример публикации и обработки события:

```rust
let bus = EventBus::new();
bus.subscribe(Arc::new(ImmuneSystem));
bus.publish(&LymphaticFilterActivated {
    function_id: "f1".into(),
    similarity: 0.91,
    decision: LymphaticDecision::Remove,
});

struct ImmuneSystem;
impl Subscriber for ImmuneSystem {
    fn on_event(&self, ev: &dyn Event) {
        if let Some(ev) = ev.as_any().downcast_ref::<LymphaticFilterActivated>() {
            if matches!(ev.decision, LymphaticDecision::Remove) {
                // блокировка или удаление гена
            }
        }
    }
}
```

## Риски тонких различий

Иногда функции выглядят одинаково, но различаются:

- побочными эффектами (I/O, состояние);
- диапазонами входных значений;
- требованиями к производительности или памяти;
- зависимостями от внешних API.

Слияние таких функций может вызвать ошибки на границах входа или регрессию по
времени выполнения.

### Когда дубликат можно оставить

- Различия в поведении критичны для отдельных органов или режимов.
- Производительность или потребление ресурсов существенно отличается.
- Нужна обратная совместимость с внешним API.
- Стоимость объединения выше потенциальной выгоды.

Каждое исключение фиксируется событием `lymphatic.duplicate_resolved` с
указанием причины, что позволяет иммунной системе и разработчикам отслеживать
оставленные дубликаты.
