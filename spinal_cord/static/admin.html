<!-- neira:meta
id: NEI-20270318-120140-admin-microtasks
intent: docs
summary: Обновлён бриф Anti-Idle: вывод глубины и числа активных микрозадач.
-->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neira — Панель администратора</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 0.5rem; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; min-width: 300px; flex: 1; }
    label { display: block; margin: 6px 0 4px; font-size: 0.9rem; }
    input[type=text], input[type=number] { width: 100%; padding: 6px 8px; }
    button { padding: 8px 12px; margin-right: 6px; cursor: pointer; }
    pre { background: #f6f8fa; padding: 8px; border-radius: 6px; overflow: auto; max-height: 300px; }
    small { color: #666; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:12px; font-weight:600; }
    .ok { background:#e6ffed; color:#036b26; }
    .warn { background:#fff5e5; color:#8a4600; }
    .err { background:#ffe8e6; color:#8a0000; }
  </style>
  <script>
    let BASE = location.origin;
    function qs(id) { return document.getElementById(id); }
    async function post(url, body) {
      const res = await fetch(url, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function get(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function antiIdleToggle() {
      const auth = qs('auth').value;
      const data = await post(`${BASE}/api/neira/anti_idle/toggle`, { auth });
      setJson('out', data); await refreshStatus();
    }
    async function antiIdleSet(v) {
      const auth = qs('auth').value;
      const data = await post(`${BASE}/api/neira/anti_idle/toggle`, { auth, enabled: !!v });
      setJson('out', data); await refreshStatus();
    }
    function setJson(id, obj) { qs(id).textContent = JSON.stringify(obj, null, 2); }
    async function factoryDryrun() {
      const body = JSON.parse(qs('factoryTpl').value||'{}');
      const res = await post(`${BASE}/factory/cells/dryrun`, body);
      setJson('out', res);
    }
    async function factoryCreate() {
      const body = JSON.parse(qs('factoryTpl').value||'{}');
      const res = await post(`${BASE}/factory/cells`, body);
      setJson('out', res);
    }
    async function factoryApprove() {
      const id = qs('fid').value.trim(); if(!id) return;
      const res = await post(`${BASE}/factory/cells/${encodeURIComponent(id)}/approve`);
      setJson('out', res);
    }
    async function factoryDisable() {
      const id = qs('fid').value.trim(); if(!id) return;
      const res = await post(`${BASE}/factory/cells/${encodeURIComponent(id)}/disable`);
      setJson('out', res);
    }
    async function factoryRollback() {
      const id = qs('fid').value.trim(); if(!id) return;
      const res = await post(`${BASE}/factory/cells/${encodeURIComponent(id)}/rollback`);
      setJson('out', res);
    }

    async function actionPause(drain) {
      const auth = qs('auth').value;
      const reason = qs('reason').value || 'maintenance';
      const body = { auth, reason, request_id: `admin-${Date.now()}` };
      if (drain) body.drain_active_streams = true;
      const data = await post(`${BASE}/api/neira/control/pause`, body);
      setJson('out', data); await refreshStatus();
    }
    async function actionResume() {
      const auth = qs('auth').value;
      const data = await post(`${BASE}/api/neira/control/resume`, { auth, request_id: `admin-${Date.now()}` });
      setJson('out', data); await refreshStatus();
    }
    async function actionKill() {
      const auth = qs('auth').value;
      const grace_ms = Number(qs('grace').value || 1000);
      const data = await post(`${BASE}/api/neira/control/kill`, { auth, grace_ms, request_id: `admin-${Date.now()}` });
      setJson('out', data);
    }
    async function refreshStatus() {
      const s = await get(`${BASE}/api/neira/control/status`);
      setJson('status', s);
      const q = await get(`${BASE}/api/neira/queues/status`);
      setJson('queues', q);
      const i = await get(`${BASE}/api/neira/introspection/status`);
      setJson('introspection', i);
      // idle brief
      try {
        const ai = i.anti_idle || {};
        const map = ['active','short','long','deep'];
        const label = map[ai.idle_state|0] || String(ai.idle_state||'n/a');
        const lbl = ai.idle_label || label;
        const depth = (ai.microtasks && (ai.microtasks.depth ?? ai.microtasks.dryrun_depth)) || 0;
        const running = ((ai.microtasks && ai.microtasks.tasks) || []).filter(t => t.running).length;
        qs('idleBrief').textContent = `Anti-Idle: ${ai.enabled? 'ON':'OFF'}, state=${lbl}, since=${ai.since_seconds||0}s, очередь=${depth}, активные=${running}`;
      } catch {}
      // badges
      qs('pausedBadge').className = 'badge ' + (s.paused ? 'warn':'ok');
      qs('pausedBadge').textContent = s.paused ? 'Пауза' : 'Работает';
      qs('safeBadge').className = 'badge ' + (i.safe_mode ? 'warn':'ok');
      qs('safeBadge').textContent = i.safe_mode ? 'Safe‑mode' : 'Обычный режим';
      // краткие метрики
      try {
        const resp = await fetch(`${BASE}/metrics`);
        const txt = await resp.text();
        const sse = (/^sse_active\s+(\d+(?:\.\d+)*)/m.exec(txt)||[])[1] || '0';
        const bp = q.backpressure || 0;
        qs('metricsBrief').textContent = `SSE активных: ${sse} · Давление: ${bp}`;
      } catch {}
    }
    async function doSnapshot() {
      const level = qs('loglevel').value || 'INFO';
      const request_id = qs('traceReq').value || '';
      const url = `${BASE}/api/neira/inspect/snapshot?include=metrics,context,logs&zip=1&level=${encodeURIComponent(level)}${request_id?`&request_id=${encodeURIComponent(request_id)}`:''}`;
      const data = await get(url);
      setJson('snapshot', data);
      const links = [];
      if (data.public_url) links.push(`<a href="${data.public_url}" target="_blank">snapshot.json</a>`);
      if (data.zip_url) links.push(`<a href="${data.zip_url}" target="_blank">snapshot.zip</a>`);
      if (data.logs_tail_file) {
        const name = String(data.logs_tail_file).split(/[\\/]/).pop();
        links.push(`<a href="/snapshots/${name}" target="_blank">logs-tail.log</a>`);
      }
      if (data.trace_file) {
        const name = String(data.trace_file).split(/[\\/]/).pop();
        links.push(`<a href="/snapshots/${name}" target="_blank">trace.json</a>`);
      }
      qs('snapLinks').innerHTML = links.join(' · ');
    }
    async function showTrace() {
      const id = qs('traceReq').value.trim(); if (!id) return;
      try { const t = await get(`${BASE}/api/neira/trace/${encodeURIComponent(id)}`); setJson('trace', t); }
      catch (e) { qs('trace').textContent = 'трасса не найдена'; }
    }
    window.addEventListener('load', refreshStatus);
  </script>
</head>
<body>
  <h1>Neira — Панель администратора
    <span id="pausedBadge" class="badge">...</span>
    <span id="safeBadge" class="badge">...</span>
  </h1>
  <div class="row">
    <div class="card">
      <h3>Авторизация</h3>
      <label>Токен администратора</label>
      <input id="auth" type="text" placeholder="вставьте токен" />
      <small>Используется в командах паузы/возобновления/остановки</small>
    </div>
    <div class="card">
      <h3>Пауза / Возобновление</h3>
      <label>Причина паузы</label>
      <input id="reason" type="text" placeholder="maintenance / нагрузка / инцидент" />
      <div style="margin-top:8px;">
        <button onclick="actionPause(false)">Пауза</button>
        <button onclick="actionPause(true)">Пауза + Дренаж SSE</button>
        <button onclick="actionResume()">Возобновить</button>
      </div>
      <h3 style="margin-top:16px;">Останов</h3>
      <label>Grace, мс</label>
      <input id="grace" type="number" value="1000" />
      <div style="margin-top:8px;"><button onclick="actionKill()">Остановить (graceful)</button></div>
    </div>
    <div class="card">
      <h3>Снимок (Snapshot)</h3>
      <label>Уровень логов (фильтр)</label>
      <input id="loglevel" type="text" value="INFO" />
      <label>request_id (для трассы в snapshot)</label>
      <input id="traceReq" type="text" placeholder="введите request_id" />
      <div style="margin-top:8px;"><button onclick="doSnapshot()">Сделать snapshot (ZIP)</button></div>
      <div id="snapLinks" style="margin-top:8px;"></div>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card">
      <h3>Статус</h3>
      <button onclick="refreshStatus()">Обновить</button>
      <div><small id="metricsBrief"></small></div>
      <div><small id="idleBrief"></small></div>
      <div style="margin-top:6px;">
        <button onclick="antiIdleToggle()">Anti‑Idle: Toggle</button>
        <button onclick="antiIdleSet(true)">Enable</button>
        <button onclick="antiIdleSet(false)">Disable</button>
        <span style="margin-left:8px"></span>
        <button onclick="traceToggle()">Trace: Toggle</button>
        <button onclick="traceSet(true)">Enable</button>
        <button onclick="traceSet(false)">Disable</button>
      </div>
      <div style="margin-top:6px;">
        <button onclick="antiIdleToggle()">Anti‑Idle: Toggle</button>
        <button onclick="antiIdleSet(true)">Enable</button>
        <button onclick="antiIdleSet(false)">Disable</button>
      </div>
      <pre id="status"></pre>
    </div>
    <div class="card">
      <h3>Очереди</h3>
      <pre id="queues"></pre>
    </div>
    <div class="card">
      <h3>Интроспекция</h3>
      <pre id="introspection"></pre>
    </div>
    <div class="card">
      <h3>Factory (Adapter)</h3>
      <small>Dry‑run / Create / Approve / Disable / Rollback</small>
      <textarea id="factoryTpl" style="width:100%;height:140px;">{
  "backend": "adapter",
  "tpl": {"id":"analysis.summarize.v1","version":"0.1.0","analysis_type":"summary","links":[],"metadata":{"schema":"v1"}}
}</textarea>
      <div style="margin-top:6px;">
        <button onclick="factoryDryrun()">Dry‑Run</button>
        <button onclick="factoryCreate()">Create (draft)</button>
      </div>
      <div style="margin-top:6px;">
        <input id="fid" type="text" placeholder="factory id" />
        <button onclick="factoryApprove()">Approve</button>
        <button onclick="factoryDisable()">Disable</button>
        <button onclick="factoryRollback()">Rollback</button>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:16px;">
    <div class="card">
      <h3>Трасса по request_id</h3>
      <div style="margin-top:8px;"><button onclick="showTrace()">Показать трассу</button></div>
      <pre id="trace"></pre>
    </div>
    <div class="card">
      <h3>Результат последней операции</h3>
      <pre id="out"></pre>
      <h3>Snapshot (JSON)</h3>
      <pre id="snapshot"></pre>
    </div>
  </div>
</body>
</html>
